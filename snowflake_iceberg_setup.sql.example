-- Optimal Iceberg Table Structure for Mantra Recitation App
-- Using Snowflake as Iceberg Catalog

-- INSTRUCTIONS:
-- 1. Copy this file to snowflake_iceberg_setup.sql
-- 2. Replace the following placeholders:
--    - YOUR_AWS_ACCOUNT_ID
--    - YOUR_S3_BUCKET_NAME
--    - YOUR_IAM_ROLE_NAME
-- 3. Run in Snowflake with ACCOUNTADMIN role

-- Create database and schema
CREATE DATABASE IF NOT EXISTS MANTRA_TRACKER;
USE DATABASE MANTRA_TRACKER;
CREATE SCHEMA IF NOT EXISTS ICEBERG_TABLES;
USE SCHEMA ICEBERG_TABLES;

-- Step 1: Create Storage Integration (if not already created)
-- Note: Requires ACCOUNTADMIN role
USE ROLE ACCOUNTADMIN;

CREATE STORAGE INTEGRATION IF NOT EXISTS snowflake_s3_integration
  TYPE = EXTERNAL_STAGE
  STORAGE_PROVIDER = 'S3'
  ENABLED = TRUE
  STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/YOUR_IAM_ROLE_NAME'
  STORAGE_ALLOWED_LOCATIONS = ('s3://YOUR_S3_BUCKET_NAME/iceberg/');

-- Step 2: Create External Volume for Iceberg tables
CREATE EXTERNAL VOLUME IF NOT EXISTS iceberg_storage_volume
  STORAGE_LOCATIONS = (
    (
      NAME = 'mantra-iceberg-storage'
      STORAGE_PROVIDER = 'S3'
      STORAGE_BASE_URL = 's3://YOUR_S3_BUCKET_NAME/iceberg/'
      STORAGE_AWS_ROLE_ARN = 'arn:aws:iam::YOUR_AWS_ACCOUNT_ID:role/YOUR_IAM_ROLE_NAME'
    )
  );

-- 1. MANTRAS TABLE (Dimension - Small, slow-changing)
-- Note: Iceberg limitations - no DEFAULT values, JSON, VARIANT, or GENERATED columns
CREATE OR REPLACE ICEBERG TABLE mantras (
    id STRING NOT NULL,
    name STRING NOT NULL,
    sanskrit STRING,
    gurmukhi STRING,
    translation STRING,
    category STRING,
    traditional_count INTEGER,
    audio_url STRING,
    source STRING, -- 'core', 'user', 'pending'
    user_id STRING,
    submitted_by STRING,
    submitted_at TIMESTAMP_NTZ,
    created_at TIMESTAMP_NTZ,
    updated_at TIMESTAMP_NTZ
)
CATALOG = 'SNOWFLAKE'
EXTERNAL_VOLUME = 'iceberg_storage_volume'
BASE_LOCATION = 'mantras/';

-- 2. USERS TABLE (Dimension - Small)
CREATE OR REPLACE ICEBERG TABLE users (
    id STRING NOT NULL,
    email STRING UNIQUE,
    username STRING,
    full_name STRING,
    timezone STRING,
    preferences STRING, -- Store user preferences as JSON string (Iceberg doesn't support JSON/VARIANT)
    created_at TIMESTAMP_NTZ,
    updated_at TIMESTAMP_NTZ
)
CATALOG = 'SNOWFLAKE'
EXTERNAL_VOLUME = 'iceberg_storage_volume'
BASE_LOCATION = 'users/';

-- 3. RECITATIONS TABLE (Fact - Large, frequent inserts)
-- Note: Iceberg auto-optimizes without explicit partitioning
CREATE OR REPLACE ICEBERG TABLE recitations (
    id STRING NOT NULL,
    user_id STRING NOT NULL,
    mantra_name STRING NOT NULL,
    count INTEGER NOT NULL,
    duration_minutes INTEGER NOT NULL,
    recitation_timestamp TIMESTAMP_NTZ NOT NULL,
    notes STRING,
    created_at TIMESTAMP_NTZ,
    updated_at TIMESTAMP_NTZ
)
CATALOG = 'SNOWFLAKE'
EXTERNAL_VOLUME = 'iceberg_storage_volume'
BASE_LOCATION = 'recitations/';

-- 4. DYNAMIC TABLES for Analytics (Optional but Recommended)
-- Daily aggregations for fast dashboard queries
CREATE OR REPLACE DYNAMIC TABLE daily_stats
TARGET_LAG = '1 hour'
WAREHOUSE = 'COMPUTE_WH'
AS
SELECT
    user_id,
    DATE(recitation_timestamp) as recitation_date,
    COUNT(*) as total_sessions,
    SUM(count) as total_recitations,
    SUM(duration_minutes) as total_duration_minutes,
    AVG(count) as avg_recitations_per_session,
    AVG(duration_minutes) as avg_duration_per_session,
    COUNT(DISTINCT mantra_name) as unique_mantras_practiced
FROM recitations
GROUP BY user_id, DATE(recitation_timestamp);

-- Monthly trends
CREATE OR REPLACE DYNAMIC TABLE monthly_trends
TARGET_LAG = '1 day'
WAREHOUSE = 'COMPUTE_WH'
AS
SELECT
    user_id,
    YEAR(recitation_timestamp) as recitation_year,
    MONTH(recitation_timestamp) as recitation_month,
    COUNT(*) as sessions,
    SUM(count) as total_count,
    SUM(duration_minutes) as total_duration,
    COUNT(DISTINCT mantra_name) as unique_mantras,
    COUNT(DISTINCT DATE(recitation_timestamp)) as active_days
FROM recitations
GROUP BY user_id, YEAR(recitation_timestamp), MONTH(recitation_timestamp);

-- Performance Optimization
-- Note: Clustering with expressions not supported on Iceberg tables
-- Uncomment and adjust if needed:
-- ALTER ICEBERG TABLE recitations CLUSTER BY (user_id);
-- ALTER ICEBERG TABLE mantras CLUSTER BY (user_id, category);

-- ICEBERG LIMITATIONS IN SNOWFLAKE:
-- ❌ No DEFAULT values on columns
-- ❌ No JSON or VARIANT data types (use STRING instead)
-- ❌ No GENERATED ALWAYS AS columns
-- ❌ No PARTITION BY with expressions
-- ❌ Limited clustering support
-- ✅ Automatic Parquet storage format
-- ✅ Time travel and versioning
-- ✅ ACID transactions
